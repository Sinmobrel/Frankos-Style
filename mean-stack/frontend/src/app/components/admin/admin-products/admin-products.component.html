<div class="admin-container"></div>
<h1 class="admin-title">Administración de Sastrería y Trajes</h1>

<div class="admin-panel">
    <div class="admin-form">
        <h2>{{ editMode ? 'Editar Producto' : 'Agregar Nuevo Producto' }}</h2>

        <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
            <div class="form-group">
                <label for="name">Nombre del Producto</label>
                <input type="text" id="name" formControlName="name" class="form-control"
                    [class.is-invalid]="productForm.get('name')?.invalid && productForm.get('name')?.touched">
                @if (productForm.get('name')?.invalid && productForm.get('name')?.touched) {
                <div class="error-message">
                    El nombre es requerido y debe tener al menos 3 caracteres.
                </div>
                }
            </div>

            <div class="form-group">
                <label for="description">Descripción</label>
                <textarea id="description" formControlName="description" class="form-control"
                    [class.is-invalid]="productForm.get('description')?.invalid && productForm.get('description')?.touched"
                    rows="3"></textarea>
                @if (productForm.get('description')?.invalid && productForm.get('description')?.touched) {
                <div class="error-message">
                    La descripción es requerida.
                </div>
                }
            </div>

            <div class="form-group">
                <label for="price">Precio (CLP $)</label>
                <input type="number" id="price" formControlName="price" class="form-control"
                    [class.is-invalid]="productForm.get('price')?.invalid && productForm.get('price')?.touched" min="0"
                    step="1">
                @if (productForm.get('price')?.invalid && productForm.get('price')?.touched) {
                <div class="error-message">
                    El precio es requerido y debe ser mayor o igual a 0.
                </div>
                }
            </div>

            <div class="form-group">
                <label for="image">Imagen del Producto</label>
                <div class="image-upload-container">
                    <input type="file" id="image" (change)="onFileSelected($event)" accept="image/*"
                        class="form-control file-input"
                        [class.is-invalid]="!selectedFile && productForm.get('imageUrl')?.invalid && productForm.get('imageUrl')?.touched">

                    @if (selectedFile || (productForm.get('imageUrl')?.value && editMode)) {
                    <div class="image-preview-container">
                        <img [src]="imagePreview || productForm.get('imageUrl')?.value" alt="Vista previa"
                            class="image-preview" />
                        <button type="button" class="btn btn-sm btn-delete remove-image" (click)="removeImage()">
                            ×
                        </button>
                    </div>
                    }

                    @if (!selectedFile && productForm.get('imageUrl')?.invalid && productForm.get('imageUrl')?.touched)
                    {
                    <div class="error-message">
                        La imagen del producto es requerida.
                    </div>
                    }
                </div>
            </div>

            <div class="form-group">
                <label for="category">Categoría</label>
                <select id="category" formControlName="category" class="form-control"
                    [class.is-invalid]="productForm.get('category')?.invalid && productForm.get('category')?.touched">
                    <option value="">Seleccionar Categoría</option>
                    <option value="trajes">Trajes</option>
                    <option value="camisas">Camisas</option>
                    <option value="corbatas">Corbatas y Pajaritas</option>
                    <option value="calzado">Calzado Formal</option>
                    <option value="accesorios">Gemelos y Accesorios</option>
                </select>
                @if (productForm.get('category')?.invalid && productForm.get('category')?.touched) {
                <div class="error-message">
                    La categoría es requerida.
                </div>
                }
            </div>

            <div class="form-group">
                <label for="stock">Stock Disponible</label>
                <input type="number" id="stock" formControlName="stock" class="form-control"
                    [class.is-invalid]="productForm.get('stock')?.invalid && productForm.get('stock')?.touched" min="0">
                @if (productForm.get('stock')?.invalid && productForm.get('stock')?.touched) {
                <div class="error-message">
                    El stock es requerido y debe ser mayor o igual a 0.
                </div>
                }
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" [disabled]="productForm.invalid">
                    {{ editMode ? 'Actualizar Producto' : 'Crear Producto' }}
                </button>
                @if (editMode) {
                <button type="button" class="btn btn-secondary" (click)="resetForm()">
                    Cancelar
                </button>
                }
            </div>
        </form>
    </div>

    <div class="admin-list">
        <h2>Catálogo de Sastrería</h2>

        @if (loading) {
        <div class="loading">Cargando productos...</div>
        } @else if (error) {
        <div class="error-message">{{ error }}</div>
        } @else if (products.length === 0) {
        <div class="empty-message">El catálogo de trajes está vacío. Añada sus primeros productos de alta costura.</div>
        } @else {
        <div class="table-responsive">
            <table class="products-table">
                <thead>
                    <tr>
                        <th class="image-header">Imagen</th>
                        <th class="name-header">Nombre</th>
                        <th class="category-header">Categoría</th>
                        <th class="price-header">Precio</th>
                        <th class="stock-header">Stock</th>
                        <th class="actions-header">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @for (product of products; track product._id) {
                    <tr>
                        <td data-label="Imagen">
                            <img [src]="product.imageUrl" alt="{{product.name}}" class="product-thumbnail" />
                        </td>
                        <td data-label="Nombre" class="product-name">{{ product.name }}</td>
                        <td data-label="Categoría" class="product-category">{{ product.category }}</td>
                        <td data-label="Precio" class="product-price">{{ product.price |
                            currency:'CLP':'symbol-narrow':'1.0-0' }}</td>
                        <td data-label="Stock" class="product-stock">{{ product.stock }}</td>
                        <td class="actions-cell">
                            <div class="button-container">
                                <button class="btn btn-sm btn-edit" (click)="editProduct(product)">
                                    Editar
                                </button>
                                <button class="btn btn-sm btn-delete" (click)="deleteProduct(product._id || '')">
                                    Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        }
    </div>
</div>